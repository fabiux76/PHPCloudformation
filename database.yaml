#https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html
AWSTemplateFormatVersion: 2010-09-09
Description: ---

Parameters: 
  DBUser:
    NoEcho: true
    Description: The database admin account username
    Type: String
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBPassword:
    NoEcho: true
    Description: The database admin account password
    Type: String
    MinLength: 8
    MaxLength: 41
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
  DBName:
    Default: ebdb
    Description: The database name
    Type: String
    MinLength: 1
    MaxLength: 64
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  WebServerSecurityGroup:
    Description: The EC2 security group that contains instances that need access to the database
    Type: AWS::EC2::SecurityGroup::GroupName
#Mappings: 
#sarebbero da mettere: instance 
#- DBInstanceClass
#- DBAllocatedStorage 
#- MultiAZDatabase
#cfr: https://s3.us-west-2.amazonaws.com/cloudformation-templates-us-west-2/RDS_MySQL_With_Read_Replica.template

Resources: 
  DBEC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Open database for access
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: '3306'
        ToPort: '3306'
        SourceSecurityGroupName:
          Ref: WebServerSecurityGroup
  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName:
        Ref: DBName
      Engine: MySQL
      #EngineVersion:
      #DBSubnetGroupName: QUESTO SOPRATTUTTO NON MI TORNA... NON DEVO SPECIFICARLO?!?!
      MultiAZ: false
      MasterUsername:
        Ref: DBUser
      DBInstanceClass: db.t2.micro
      AllocatedStorage: 20
      #StorageType: standard | gp2 | io1
      MasterUserPassword:
        Ref: DBPassword
      VPCSecurityGroups:
      - !GetAtt DBEC2SecurityGroup.GroupId
      #AvailabilityZone: 
      #BackupRetentionPeriod: 
      #DBInstanceIdentifier: 
      PubliclyAccessible: true
      Tags:
        - Key: keyname
          Value: value

#Outputs: